{
  "hash": "5ce33c41c4087a805b9c95e039c1ab5f",
  "result": {
    "markdown": "---\ntitle: \"Tutorial for moimix\"\noutput: html_document\n---\n\n\n\n\n## The Data\n\nWe use an example dataset from the Pf3k Project consisting of 113 samples from the Democratic Republic of the Congo and 247,496 biallelic SNPs. See [the main Data tab](https://mrc-ide.github.io/PGEforge/website_docs/data_description.html) of PGEforge website for further details.\n\n\n## Transforming raw VCF files\n\nThese functions transform VCF files into GDS files and summarize key aspects including the sample IDs, and the loci that were genotyped. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(moimix)\nlibrary(SeqArray)\nlibrary(here)\n\nlocal_path<- \"../../data/wgs/pf3k/DRCongo/\"\nfile_name_vcf<- \"SNP_INDEL_Pf3D7_ALL_v3.combined.filtered.vqslod6.biallelic_snp.DRCongo.vcf.gz\"\n\nfile_name_gds<- \"SNP_INDEL_Pf3D7_ALL_v3.combined.filtered.vqslod6.biallelic_snp.DRCongo.gds\"\n\nseqVCF2GDS(paste0(local_path,file_name_vcf),paste0(local_path,file_name_gds))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nWed Dec 13 10:38:30 2023\nVariant Call Format (VCF) Import:\n    file:\n        SNP_INDEL_Pf3D7_ALL_v3.combined.filtered.vqslod6.biallelic_snp.DRCongo.vcf.gz (56.2M)\n    file format: VCFv4.2\n    genome reference: file:///lustre/scratch109/malaria/pf3k_methods/resources/Pfalciparum.genome.fasta\n    # of sets of chromosomes (ploidy): 2\n    # of samples: 113\n    genotype field: GT\n    genotype storage: bit2\n    compression method: LZMA_RA\n    # of samples: 113\nOutput:\n    ../../data/wgs/pf3k/DRCongo/SNP_INDEL_Pf3D7_ALL_v3.combined.filtered.vqslod6.biallelic_snp.DRCongo.gds\nParsing 'SNP_INDEL_Pf3D7_ALL_v3.combined.filtered.vqslod6.biallelic_snp.DRCongo.vcf.gz':\n+ genotype/data   { Bit2 2x113x247496 LZMA_ra(4.90%), 665.1K }\nDigests:\n    sample.id  [md5: 1090c0d6eae9b8a8b643d84901a93da7]\n    variant.id  [md5: 8ecc58ce9fdb9b1f074561eacad60497]\n    position  [md5: 989865cfea687e770779ba16e3a59e38]\n    chromosome  [md5: 5a760f3dec50d195a7e35df9ce419ce6]\n    allele  [md5: f85ce875d082a9b50f62a9ee91d46b2b]\n    genotype  [md5: ddb258ba55d21df5956096ac6fa8fa5f]\n    phase  [md5: c1ebcdd70f5dd36d83085f899aa33662]\n    annotation/id  [md5: ecbbd9469d9a5d05333f05f40c810c0b]\n    annotation/qual  [md5: f66afe847a043c96641b87d369e9efa2]\n    annotation/filter  [md5: fba9ea1d66b00c80eecc59d4c9687db4]\n    annotation/info/AC  [md5: 785645421637ce81e2d694273ca1d778]\n    annotation/info/AF  [md5: f3104bcaefbe88356c6a29abaee8566f]\n    annotation/info/AN  [md5: 961d68b82c1db1f93720551a08009b8a]\n    annotation/info/DP  [md5: b2064e0ff47a44e4d4b1a4f666a2bc45]\n    annotation/info/RegionType  [md5: a13216c727fb29d0ab6b9d6d5c824dc5]\n    annotation/info/VQSLOD  [md5: 10fdf6e8ba1564f22547510e66b8dc84]\n    annotation/info/VariantType  [md5: d0cf8d602d3294c18c1f6bdc74b2cc3a]\n    annotation/format/AD  [md5: 8843d3f3bb435e9fbf6d9e8da8dc37e3]\n    annotation/format/DP  [md5: 073c2f2d47cd305b239fdba6ae843523]\n    annotation/format/GQ  [md5: 85285fb07ae48a3b243ac7151e316bd5]\nDone.\nWed Dec 13 10:39:10 2023\nOptimize the access efficiency ...\nClean up the fragments of GDS file:\n    open the file '../../data/wgs/pf3k/DRCongo/SNP_INDEL_Pf3D7_ALL_v3.combined.filtered.vqslod6.biallelic_snp.DRCongo.gds' (42.0M)\n    # of fragments: 2957\n    save to '../../data/wgs/pf3k/DRCongo/SNP_INDEL_Pf3D7_ALL_v3.combined.filtered.vqslod6.biallelic_snp.DRCongo.gds.tmp'\n    rename '../../data/wgs/pf3k/DRCongo/SNP_INDEL_Pf3D7_ALL_v3.combined.filtered.vqslod6.biallelic_snp.DRCongo.gds.tmp' (42.0M, reduced: 33.5K)\n    # of fragments: 95\nWed Dec 13 10:39:10 2023\n```\n:::\n\n```{.r .cell-code}\nmyGDS<- seqOpen(paste0(local_path,file_name_gds))\n\nseqSummary(myGDS)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nFile: /Users/sruybal/Library/CloudStorage/OneDrive-ImperialCollegeLondon/PGEforge/data/wgs/pf3k/DRCongo/SNP_INDEL_Pf3D7_ALL_v3.combined.filtered.vqslod6.biallelic_snp.DRCongo.gds\nFormat Version: v1.0\nReference: file:///lustre/scratch109/malaria/pf3k_methods/resources/Pfalciparum.genome.fasta\nPloidy: 2\nNumber of samples: 113\nNumber of variants: 247,496\nChromosomes:\n    chrPf3D7_01_v3: 5143 , chrPf3D7_02_v3: 8230 , chrPf3D7_03_v3: 10151, chrPf3D7_04_v3: 11146, chrPf3D7_05_v3: 14363, chrPf3D7_06_v3: 12818\n    chrPf3D7_07_v3: 14166, chrPf3D7_08_v3: 14041, chrPf3D7_09_v3: 16889, chrPf3D7_10_v3: 16912, chrPf3D7_11_v3: 22782, chrPf3D7_12_v3: 22999\n    chrPf3D7_13_v3: 35341, chrPf3D7_14_v3: 42515\nContigs:\n    Pf3D7_01_v3, 640851\n    Pf3D7_02_v3, 947102\n    Pf3D7_03_v3, 1067971\n    Pf3D7_04_v3, 1200490\n    Pf3D7_05_v3, 1343557\n    Pf3D7_06_v3, 1418242\n    Pf3D7_07_v3, 1445207\n    Pf3D7_08_v3, 1472805\n    Pf3D7_09_v3, 1541735\n    Pf3D7_10_v3, 1687656\n    Pf3D7_11_v3, 2038340\n    Pf3D7_12_v3, 2271494\n    Pf3D7_13_v3, 2925236\n    Pf3D7_14_v3, 3291936\n    Pf3D7_API_v3, 34250\n    Pf_M76611, 5967\nAlleles:\n    NON_REF, Represents any possible alternative allele at this location\n    tabulation: 2, 247496(100.0%)\nAnnotation, Quality:\n    Min: 30, 1st Qu: 1742.95745849609, Median: 4550.41015625, Mean: 173902.063490196, 3rd Qu: 14138.6999511719, Max: 14158800\nAnnotation, FILTER:\n    PASS, All filters passed, 247496(100.0%)\n    Centromere, RegionType == 'Centromere', 0(0.0%)\n    InternalHypervariable, RegionType == 'InternalHypervariable', 0(0.0%)\n    LowQual, Low quality, 0(0.0%)\n    Low_VQSLOD, VQSLOD <= 0.0, 0(0.0%)\n    SubtelomericHypervariable, RegionType == 'SubtelomericHypervariable', 0(0.0%)\n    SubtelomericRepeat, RegionType == 'SubtelomericRepeat', 0(0.0%)\n    VQSRTrancheINDEL99.00to99.90, Truth sensitivity tranche level for INDEL model at VQS Lod: -14.5412 <= x < -1.1199, 0(0.0%)\n    VQSRTrancheINDEL99.90to100.00+, Truth sensitivity tranche level for INDEL model at VQS Lod < -30735.5165, 0(0.0%)\n    VQSRTrancheINDEL99.90to100.00, Truth sensitivity tranche level for INDEL model at VQS Lod: -30735.5165 <= x < -14.5412, 0(0.0%)\n    VQSRTrancheSNP99.90to100.00+, Truth sensitivity tranche level for SNP model at VQS Lod < -233.1879, 0(0.0%)\n    VQSRTrancheSNP99.90to100.00, Truth sensitivity tranche level for SNP model at VQS Lod: -233.1879 <= x < -3.6643, 0(0.0%)\nAnnotation, INFO variable(s):\n    AC, A, Integer, Allele count in genotypes, for each ALT allele, in the same order as listed\n    AF, A, Float, Allele Frequency, for each ALT allele, in the same order as listed\n    AN, 1, Integer, Total number of alleles in called genotypes\n    DP, 1, Integer, Approximate read depth; some reads may have been filtered\n    RegionType, 1, String, The type of genome region within which the variant is found. SubtelomericRepeat: repetitive regions at the ends of the chromosomes. SubtelomericHypervariable: subtelomeric region of poor conservation between the 3D7 reference genome and other samples. InternalHypervariable: chromosome-internal region of poor conservation between the 3D7 reference genome and other samples. Centromere: start and end coordinates of the centromere genome annotation. Core: everything else.\n    VQSLOD, 1, Float, Log odds of being a true variant versus being false under the trained gaussian mixture model\n    VariantType, 1, String, Variant type description\nAnnotation, FORMAT variable(s):\n    GT, 1, String, Genotype\n    AD, R, Integer, Allelic depths for the ref and alt alleles in the order listed\n    DP, 1, Integer, Approximate read depth (reads with MQ=255 or with bad mates are filtered)\n    GQ, 1, Integer, Genotype Quality\nAnnotation, sample variable(s):\n    <None>\n```\n:::\n\n```{.r .cell-code}\nsample.id<- seqGetData(myGDS, \"sample.id\")\nhead(sample.id)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"QG0182-C\" \"QG0183-C\" \"QG0184-C\" \"QG0185-C\" \"QG0186-C\" \"QG0187-C\"\n```\n:::\n\n```{.r .cell-code}\ncoords<- getCoordinates(myGDS)\nhead(coords)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   chromosome position variant.id\n1 Pf3D7_01_v3    92914          1\n2 Pf3D7_01_v3    92942          2\n3 Pf3D7_01_v3    92952          3\n4 Pf3D7_01_v3    93022          4\n5 Pf3D7_01_v3    93157          5\n6 Pf3D7_01_v3    93206          6\n```\n:::\n:::\n\n\n\nThere is also a function that allows loci on the apicoplast to be filtered out.\n\n::: {.cell}\n\n```{.r .cell-code}\nseqSetFilter(myGDS, \n             variant.id = coords$variant.id[coords$chromosome != \"Pf3D7_API_v3\"])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# of selected variants: 247,496\n```\n:::\n:::\n\n\n\n## Estimating B-allele frequencies\n\nThese functions allow the B-allele frequency matrix to be estimated across all samples and all loci. \n\nFor each sample we can also visualize the within sample allele frequency across each locus. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nBAF_estimates<- bafMatrix(myGDS)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# of selected variants: 247,496\n# of selected samples: 113\n# of selected variants: 247,496\n```\n:::\n\n```{.r .cell-code}\nstr(BAF_estimates)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nList of 3\n $ baf_matrix: num [1:113, 1:247496] 0 0 0 0 0 0 0 0 0 0 ...\n  ..- attr(*, \"dimnames\")=List of 2\n  .. ..$ sample : chr [1:113] \"QG0182-C\" \"QG0183-C\" \"QG0184-C\" \"QG0185-C\" ...\n  .. ..$ variant: chr [1:247496] \"1\" \"2\" \"3\" \"4\" ...\n $ baf_site  : num [1:247496] 0 0 0 0 0 ...\n $ coords    :'data.frame':\t247496 obs. of  3 variables:\n  ..$ chromosome: chr [1:247496] \"Pf3D7_01_v3\" \"Pf3D7_01_v3\" \"Pf3D7_01_v3\" \"Pf3D7_01_v3\" ...\n  ..$ position  : int [1:247496] 92914 92942 92952 93022 93157 93206 93378 93526 93560 93651 ...\n  ..$ variant.id: int [1:247496] 1 2 3 4 5 6 7 8 9 10 ...\n - attr(*, \"class\")= chr \"bafMatrix\"\n```\n:::\n\n```{.r .cell-code}\n#for one single sample\n\nplot(BAF_estimates, \"QG0182-C\")\n```\n\n::: {.cell-output-display}\n![](moimix_analysis_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n## Identifying polyclonal infections using the binomial mixture model \n\n\nThese functions implement a binomial mixture model for each sample to estimate whether a sample is polyclonal and how many clones may be present in that sample. The implementation of the mixture model uses the reference and alternative allele frequencies at each locus as the outcome variable the number of components is user specified and corresponds to the MOI in the sample. \n\nIn order to identify a good candidate MOI to specify in the model, the user can visually inspect the B-allele frequency plots above, and identify how many clusters of within host allele frequencies are present. Note that this package does not allow more than 5 components in the mixture models.  \n\n\n\n\nThe model output below shows a model with 2 components. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(333)\n\n\ncounts<- alleleCounts(myGDS)\n\nm1 <- binommix(counts, sample.id = \"QG0182-C\", k= 2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n2 : * * * * *\n```\n:::\n\n```{.r .cell-code}\nsummary(m1$fits)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nflexmix::initFlexmix(y_obs ~ 1, model = flexmix::FLXMRglm(y_obs ~ \n    1, family = \"binomial\"), k = 2, control = list(iter.max = niter, \n    minprior = 0), nrep = 5)\n\n       prior size post>0 ratio\nComp.1 0.601 1206   1216 0.992\nComp.2 0.399  800    820 0.976\n\n'log Lik.' -7116.803 (df=3)\nAIC: 14239.61   BIC: 14256.42 \n```\n:::\n\n```{.r .cell-code}\nm2 <- binommix(counts, sample.id = \"QG0182-C\", k= 3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n3 : * * * * *\n```\n:::\n\n```{.r .cell-code}\nsummary(m2$fits)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nflexmix::initFlexmix(y_obs ~ 1, model = flexmix::FLXMRglm(y_obs ~ \n    1, family = \"binomial\"), k = 3, control = list(iter.max = niter, \n    minprior = 0), nrep = 5)\n\n         prior size post>0  ratio\nComp.1 0.39821  799    814 0.9816\nComp.2 0.00933   17    204 0.0833\nComp.3 0.59246 1190   1199 0.9925\n\n'log Lik.' -6604.748 (df=5)\nAIC: 13219.5   BIC: 13247.51 \n```\n:::\n:::\n\n\nBoth the mean within host allele frequency across loci for each of the components (presumed number of clones in a sample) and the relative weights in each of the components are also output in the estimates. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nestimates<- getTheta(m1$fits)\nestimates\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n     pi.hat    mu.hat\n1 0.6006535 0.8704560\n2 0.3993465 0.1285044\n```\n:::\n\n```{.r .cell-code}\nplot(BAF_estimates, \"QG0182-C\")\nabline(h= estimates$mu.hat, col='red')\n```\n\n::: {.cell-output-display}\n![](moimix_analysis_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n## Using Fws to identify polyclonal infections\n\nFinally Fws is estimated for each sample and a sample can be designated as polyclonal if Fws is estimated to be less than 0.95. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nfws_est<- getFws(myGDS)\n\nhist(fws_est)\n```\n\n::: {.cell-output-display}\n![](moimix_analysis_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n\n```{.r .cell-code}\nfws_est[\"QG0182-C\"]<0.95\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nQG0182-C \n    TRUE \n```\n:::\n:::\n\n\n\n## Summary\n\nWe have taken a VCF file of bialleleic SNP data, estimated B-allele frequencies, visually estimated MOI using the within host allele frequencies, and fit a model to estimate the mean within host frequencies across loci for each of the presumed number of clones in the sample. ",
    "supporting": [
      "moimix_analysis_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}