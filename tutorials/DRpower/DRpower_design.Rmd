---
title: "Designing a drug and diagnostic resistance study"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Premise

Here, we will use *DRpower* to help us design a prospective malaria molecular surveillance (MMS) study in the Democratic Republic of the Congo (DRC). We are interested in the following questions:

1. What is the prevalence of sulfadoxine/pyrimethamine (SP) mutations?
2. Are there any *pfkelch13* mutations?
3. What is the prevalence of *pfhrp2/3* gene deletions, and is this prevalence above 5% (the WHO threshold at which a nationwide change in RDTs is recommended)?

Based on initial budget calculations, we hope to collect 100 samples from each of 3 sites in each of 10 provinces. We want to know what sort of power we can expect with these numbers for each of the end-points above.

## SP mutation prevalence - margin of error (MoE) calculation

Our plan is to pool results over the 3 sites within each province to arrive at an estimate of the overall prevalence of SP mutations at the province level. When pooling results, we need to take account of intra-cluster correlation in our confidence intervals (CIs). Failure to do so will lead to unrealistically tight intervals. *DRpower* provides several functions for calculating the expected margin of error (MoE) given assumptions about sample size and the known prevalence of mutations.

First, let's load the package and set the random seed so our results are reproducible:

```{r}
library(DRpower)
set.seed(1)
```

Then we will use the `get_margin()` function to tell us the MoE we can expect if the prevalence of the mutation is 10%. We set the parameters to represent 3 clusters of 100 samples:

```{r}
# get MoE using simple calculation
get_margin(N = 100, n_clust = 3, prevalence = 0.1, ICC = 0.05)
```

We expect 8.3% MoE, meaning we expect to estimate the prevalence to within plus or minus 8.3% (so from 1.7% to 18.3%). This is quite a precise estimate.

Our worst case MoE will occur when the prevalence of the marker is 50%. We can explore this here:

```{r}
# get worst case MoE
get_margin(N = 100, n_clust = 3, prevalence = 0.5, ICC = 0.05)
```

In the worst case, our MoE goes up to 14%. This is still quite precise.

However, this approach assumes that we know the level of intra-cluster correlation (ICC) exactly. It also assumes a normal distribution when producing the CI, which may not be appropriate. A more cautious approach is to estimate prevalence using the Bayesian model within *DRpower*. This model accounts for uncertainty in the ICC. If we plan to use the Bayesian model then we should use the `get_margin_Bayesian()` function:

```{r}
# get expected MoE via the Bayesian approach
get_margin_Bayesian(N = rep(100, 3), prevalence = 0.1, reps = 1e2)
```

We now only get an estimate of the MoE, although it appears reasonably precise. We could increase the number of `reps` to make this more precise if we wanted. We can expect our 95% credible interval (CrI) to span from 3.9% to 25.1%. Interestingly, this is narrower at the low end than our simple estimate, but wider at the high end. We can explore our worst case MoE using the same method:

```{r}
# get worst case MoE via the Bayesian approach
get_margin_Bayesian(N = rep(100, 3), prevalence = 0.5, reps = 1e2)
```

In the worst case, we can expect to estimate prevalence from 33.5% to 65.6%. So we should be able to determine roughly which third of the prevalence range the mutation occupies (i.e. "low", "intermediate" or "high"), but not much more precise than this.

## *pfkelch13* mutations - presence/absence analysis

When it comes to *pfkelch13*, we are interested in knowing if there are *any* mutants in the province, rather than estimating the prevalence of mutants. A single positive sample would prove that there are. However, if the prevalence is very low then we may get unlucky and miss all positive samples. We can use the `get_power_presence()` function to explore our probability of detecting at least one positive sample:

```{r}
# get power when prevalence is 1%
get_power_presence(N = rep(100, 3), prevalence = 0.01)
```

We can see that for *pfkelch13* mutants at 1% prevalence, we would only have a 65% chance of detecting one in *any* of our 3 sites within a province. This is quite low power. Compare that to the result if we assume mutants are at 2% in the province:

```{r}
# get power when prevalence is 2%
get_power_presence(N = rep(100, 3), prevalence = 0.02)
```

We now have close to 90% power. So, we can say we are powered to detect rare variants down to around 2%, but if they are less common than this then we risk missing them. Whether or not this is an acceptable level of power depends on programmatic factors, amongst others.

## *pfhrp2/3* deletions - comparison against 5% threshold

We plan to follow the [WHO Master Protocol](https://iris.who.int/bitstream/handle/10665/331197/9789240002050-eng.pdf) approach, changing RDTs at a national level if any province has a prevalence of *pfhrp2/3* deletions significantly over 5%. We can use the `get_power()` function to calculate our power for a given prevalence of deletions:

```{r}
# estimate power under WHO approach
get_power(N = rep(100, 3), prevalence = 0.1, prev_thresh = 0.05, reps = 1e3)
```

We only have around 60% power under this design. We would obtain a higher power if we assumed the prevalence of *pfhrp2/3* deletions was higher than 10%, but we would need to be able to justify this assumption with evidence - for example results of a pilot study, or results from neighboring countries.

In our case, we will instead abandon the threshold comparison approach in favour of a two-step design. Our new plan is to look for the presence of *any* *pfhrp2/3* deletions at the province level, and only if these are detected we will perform a followup study in that province. The nice thing here is that we have already performed this power calculation, as it becomes a presence/absence analysis exactly as we did above for *pfkelch13*. We know that we have power to detect something down to around 2% prevalence.

For our followup study, we can explore what would happen if we doubled the number of sites in that province:

```{r}
# estimate power with 6 sites of 100
get_power(N = rep(100, 6), prevalence = 0.1, prev_thresh = 0.05, reps = 1e3)
```

We find that power is around 79%, which is acceptable.

## Summary

We have used *DRpower* to explore the kind of precision and power we can expect for a given study design. This has revealed that:

1. When estimating SP mutations, we will have only a rough idea of the prevalence. Probably in the "low" vs. "intermediate" vs. "high" range.
2. For *pfkelch13* mutations, we are powered to detect rare variants down to around 2%. Any lower than this and we run a real risk of missing them.
3. For *pfhrp2/3* deletions, we do not have power under the WHO Master Protocol approach. We have therefore modified our study design to a two-stage process that focuses first on detection, and then on prevalence estimation.

